
import groovy.json.JsonOutput

class ContentModel{
    String text
    String title
    String picUrl
    String messageUrl
}
/**
 * 上传apk到蒲公英
 */
def uploadApk() {
    def apiKey = rootProject.ext.keystore["apiKey"] // todo 这里替换为自己的蒲公英的apiKey
    def buildUpdateDescription = "debug "
    //查找上传的apk文件，这里需要换成自己apk路径
    def apkDir = new File("./app/build/outputs/apk/online/debug/")
    if (!apkDir.exists()) {
        throw new RuntimeException("apk output path not exists!")
    }

    def apk = null
    for (int i = apkDir.listFiles().length - 1; i >= 0; i--) {
        File file = apkDir.listFiles()[i]
        if (file.name.endsWith(".apk")) {
            apk = file
            break
        }
    }
    if (apk == null) {
        throw new RuntimeException("apk file not exists!")
    }

    println "*************** start upload file ***************"

    //release修改这里
    logger.log(LogLevel.ERROR, "start up load apk file : ${apk.absolutePath}")
    def uploadCommand = "curl -F \"file=@${apk.absolutePath}\" -F \"_api_key=${apiKey}\" -F \"buildUpdateDescription=${buildUpdateDescription}\"  https://www.pgyer.com/apiv2/app/upload"
    Runtime runtime = Runtime.getRuntime()
    Process p = runtime.exec(uploadCommand)
    InputStream fis = p.getInputStream()
    InputStreamReader isr = new InputStreamReader(fis)
    BufferedReader br = new BufferedReader(isr)
    String line = null
    logger.log(LogLevel.ERROR, "upload result :")

    println "*************** upload finish ***************"

    while ((line = br.readLine()) != null) {
        logger.log(LogLevel.ERROR, line)
        def startStr = "\"buildShortcutUrl\":\""
        int start = line.indexOf(startStr) + startStr.length()
        int end = line.indexOf("\"", start)
        if (start > 0 && end > 0) {
            String sUrl = line.substring(start, end)
            runtime.exec("cmd   /c   start  https://www.pgyer.com/$sUrl")
        }
    }
    br.close()
    isr.close()
    fis.close()


//    sendMsgToDing(resp.data)
}

//打包测试环境apk 上传蒲公英 发送邮件功能使用蒲公英自带的邮件功能
task packageDebug {
    def apkDir = new File("./app/build/outputs/apk/online/debug/")
    if(apkDir.exists() && apkDir.isDirectory()){
        apkDir.deleteDir()
    }
    dependsOn("assembleDebug")

    doLast {
//        uploadApk()
    }
}



def sendMsgToDing(def data){
    def conn = new URL("你的钉钉webhook机器人地址").openConnection()
    conn.setRequestMethod('POST')
    conn.setRequestProperty("Connection", "Keep-Alive")
    conn.setRequestProperty("Content-type", "application/json;charset=UTF-8")
    conn.setConnectTimeout(30000)
    conn.setReadTimeout(30000)
    conn.setDoInput(true)
    conn.setDoOutput(true)
    def dos = new DataOutputStream(conn.getOutputStream())
    HashMap<String,Object> map = new HashMap<>()
    map.put("msgtype", "link")
    ContentModel contentModel = new ContentModel()
    contentModel.text = "已经上传至蒲公英,可以下载使用了"+data.buildCreated
    contentModel.title= "上传提醒"+data.buildVersion
    contentModel.picUrl = data.buildQRCodeURL
    contentModel.messageUrl= "https://www.pgyer.com/" + data.buildShortcutUrl
    map.put("link",contentModel)
    def json = JsonOutput.toJson(map)
    println(json)
    dos.writeBytes(json)
    def input = new BufferedReader(new InputStreamReader(conn.getInputStream()))
    String line =""
    String result=""
    while ((line = input.readLine()) != null) {
        result +=  line
    }
    dos.flush()
    dos.close()
    input.close()
    conn.connect()
    println(result)

}
